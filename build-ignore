#!/usr/bin/env bash
set -euo pipefail

# Git Fixes

if [ -z "${CACHED_COMMIT_REF:-}" ]; then
  exit 1
fi

if [ "${CACHED_COMMIT_REF:-}" = "${COMMIT_REF:-}" ]; then
  echo "CACHED_COMMIT_REF equals COMMIT_REF; running build."
  exit 1
fi

if ! git cat-file -e "${CACHED_COMMIT_REF}^{commit}" 2>/dev/null; then
  echo "Missing CACHED_COMMIT_REF in clone; running build."
  exit 1
fi

if ! changed_files="$(git diff --name-only "$CACHED_COMMIT_REF" "$COMMIT_REF")"; then
  echo "Unable to compute git diff; running build."
  exit 1
fi

if [ -z "$changed_files" ]; then
  echo "No changed files detected; running build."
  exit 1
fi

# Custem Rules

if printf '%s\n' "$changed_files" | grep -Ev '^(sticky-notes/|banners/|bookmarks/|backgrounds/|presentations/|imgs/|headshots/|props/|var/|$)' >/dev/null; then
  echo "Changes outside media folders detected; running build."
  exit 1
else
  echo "All changed files inside media folders; skipping build."
  exit 0
fi
